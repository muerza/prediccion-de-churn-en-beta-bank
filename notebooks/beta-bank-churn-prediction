{
 "cells": [
  {
   "cell_type": "markdown",
   "id": "310dd1aa",
   "metadata": {},
   "source": [
    "### üè¶ Proyecto: Predicci√≥n de Churn en Beta Bank\n",
    "\n",
    "#### üìå Descripci√≥n general\n",
    "\n",
    "Los clientes de Beta Bank se est√°n yendo, cada mes, poco a poco. Los banqueros descubrieron que es m√°s barato salvar a los clientes existentes que atraer nuevos.\n",
    "\n",
    "Necesitamos predecir si un cliente dejar√° el banco pronto. T√∫ tienes los datos sobre el comportamiento pasado de los clientes y la terminaci√≥n de contratos con el banco.\n",
    "\n",
    "Crea un modelo con el m√°ximo valor F1 posible. Para aprobar la revisi√≥n, necesitas un valor F1 de al menos 0.59. Verifica F1 para el conjunto de prueba. \n",
    "\n",
    "Adem√°s, debes medir la m√©trica AUC-ROC y compararla con el valor F1.\n",
    "\n",
    "#### üéØ Objetivo\n",
    "\n",
    "Crea un modelo con el m√°ximo valor F1 posible. Para aprobar la revisi√≥n, necesitas un valor F1 de al menos 0.59. Verifica F1 para el conjunto de prueba. \n",
    "\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "2adcf4d6",
   "metadata": {},
   "source": [
    "### üìÇ Descripci√≥n de los datos\n",
    "\n",
    "#### üóÇÔ∏è Fuente de datos\n",
    "\n",
    "- Archivo: `/datasets/Churn.csv`\n",
    "\n",
    "#### üî¢ Caracter√≠sticas (features)\n",
    "\n",
    "- `RowNumber`: √≠ndice de cadena de datos (n√∫mero de fila)\n",
    "- `CustomerId`: identificador √∫nico del cliente\n",
    "- `Surname`: apellido del cliente\n",
    "- `CreditScore`: Score de cr√©dito del cliente\n",
    "- `Geography`: pa√≠s de residencia del cliente\n",
    "- `Gender`: sexo del cliente\n",
    "- `Age`: edad del cliente\n",
    "- `Tenure`: per√≠odo durante el cual ha madurado el dep√≥sito a plazo fijo de un cliente (a√±os)\n",
    "- `Balance`: saldo de la cuenta bancaria\n",
    "- `NumOfProducts`: n√∫mero de productos bancarios utilizados por el cliente\n",
    "- `HasCrCard`: el cliente tiene una tarjeta de cr√©dito  \n",
    "  - `1` - s√≠  \n",
    "  - `0` - no\n",
    "- `IsActiveMember`: actividad del cliente  \n",
    "  - `1` - cliente activo  \n",
    "  - `0` - cliente inactivo\n",
    "- `EstimatedSalary`: salario estimado del cliente\n",
    "\n",
    "\n",
    "#### üéØ Variable objetivo\n",
    "\n",
    "- `Exited`: indica si el cliente **se ha ido** del banco  \n",
    "  - `1` - el cliente se fue  \n",
    "  - `0` - el cliente se qued√≥\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "06a4ddae",
   "metadata": {},
   "source": [
    "### 0. Estrategia inicial\n",
    "\n",
    "El objetivo principal es identificar a los clientes que tienen alta probabilidad de **abandonar el banco**.  \n",
    "Para ello, vamos a entrenar **modelos de clasificaci√≥n** que aprendan a distinguir entre:\n",
    "\n",
    "- Clientes que **se quedaron** (`Exited = 0`).\n",
    "- Clientes que **se fueron** (`Exited = 1`).\n",
    "\n",
    "Primero analizamos a los clientes que ya se han ido para entender **qu√© caracter√≠sticas est√°n asociadas al churn**.  \n",
    "Despu√©s, utilizamos ese conocimiento para predecir, entre los clientes actuales, **qui√©nes tienen mayor riesgo de irse** y as√≠ poder implementar **estrategias de retenci√≥n** (por ejemplo, ofertas personalizadas, contacto proactivo o revisi√≥n de condiciones del producto).\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "3873c0db",
   "metadata": {},
   "source": [
    "### 1. üì¶ Importaci√≥n de librer√≠as"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 50,
   "id": "9fd5bc99",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 1.1 Importaci√≥n de librer√≠as\n",
    "import pandas as pd\n",
    "import numpy as np\n",
    "import matplotlib.pyplot as plt\n",
    "\n",
    "from sklearn.tree import DecisionTreeClassifier\n",
    "from sklearn.ensemble import RandomForestClassifier\n",
    "from sklearn.linear_model import LogisticRegression\n",
    "from sklearn.model_selection import train_test_split\n",
    "\n",
    "from sklearn.utils import shuffle\n",
    "from sklearn.preprocessing import StandardScaler \n",
    "\n",
    "from sklearn.metrics import (\n",
    "    confusion_matrix,\n",
    "    precision_score,\n",
    "    f1_score,\n",
    "    roc_auc_score,\n",
    "    recall_score,\n",
    "    average_precision_score,\n",
    "    precision_recall_curve\n",
    ")\n",
    "\n",
    "# 1.2  Definimos el random State para toda nuestra exploraci√≥n de datos.\n",
    "RANDOM_STATE = 54321\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "5421e8c4",
   "metadata": {},
   "source": [
    "### üì• 2. Carga de datos\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e9c083de",
   "metadata": {},
   "source": [
    "\n",
    "#### üìÑ 2.1 Lectura del archivo"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "f6be2557",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>RowNumber</th>\n",
       "      <th>CustomerId</th>\n",
       "      <th>Surname</th>\n",
       "      <th>CreditScore</th>\n",
       "      <th>Geography</th>\n",
       "      <th>Gender</th>\n",
       "      <th>Age</th>\n",
       "      <th>Tenure</th>\n",
       "      <th>Balance</th>\n",
       "      <th>NumOfProducts</th>\n",
       "      <th>HasCrCard</th>\n",
       "      <th>IsActiveMember</th>\n",
       "      <th>EstimatedSalary</th>\n",
       "      <th>Exited</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1</td>\n",
       "      <td>15634602</td>\n",
       "      <td>Hargrave</td>\n",
       "      <td>619</td>\n",
       "      <td>France</td>\n",
       "      <td>Female</td>\n",
       "      <td>42</td>\n",
       "      <td>2.0</td>\n",
       "      <td>0.00</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>101348.88</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2</td>\n",
       "      <td>15647311</td>\n",
       "      <td>Hill</td>\n",
       "      <td>608</td>\n",
       "      <td>Spain</td>\n",
       "      <td>Female</td>\n",
       "      <td>41</td>\n",
       "      <td>1.0</td>\n",
       "      <td>83807.86</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>112542.58</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>3</td>\n",
       "      <td>15619304</td>\n",
       "      <td>Onio</td>\n",
       "      <td>502</td>\n",
       "      <td>France</td>\n",
       "      <td>Female</td>\n",
       "      <td>42</td>\n",
       "      <td>8.0</td>\n",
       "      <td>159660.80</td>\n",
       "      <td>3</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>113931.57</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>4</td>\n",
       "      <td>15701354</td>\n",
       "      <td>Boni</td>\n",
       "      <td>699</td>\n",
       "      <td>France</td>\n",
       "      <td>Female</td>\n",
       "      <td>39</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.00</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>93826.63</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>5</td>\n",
       "      <td>15737888</td>\n",
       "      <td>Mitchell</td>\n",
       "      <td>850</td>\n",
       "      <td>Spain</td>\n",
       "      <td>Female</td>\n",
       "      <td>43</td>\n",
       "      <td>2.0</td>\n",
       "      <td>125510.82</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>79084.10</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   RowNumber  CustomerId   Surname  CreditScore Geography  Gender  Age  \\\n",
       "0          1    15634602  Hargrave          619    France  Female   42   \n",
       "1          2    15647311      Hill          608     Spain  Female   41   \n",
       "2          3    15619304      Onio          502    France  Female   42   \n",
       "3          4    15701354      Boni          699    France  Female   39   \n",
       "4          5    15737888  Mitchell          850     Spain  Female   43   \n",
       "\n",
       "   Tenure    Balance  NumOfProducts  HasCrCard  IsActiveMember  \\\n",
       "0     2.0       0.00              1          1               1   \n",
       "1     1.0   83807.86              1          0               1   \n",
       "2     8.0  159660.80              3          1               0   \n",
       "3     1.0       0.00              2          0               0   \n",
       "4     2.0  125510.82              1          1               1   \n",
       "\n",
       "   EstimatedSalary  Exited  \n",
       "0        101348.88       1  \n",
       "1        112542.58       0  \n",
       "2        113931.57       1  \n",
       "3         93826.63       0  \n",
       "4         79084.10       0  "
      ]
     },
     "execution_count": 51,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# Ruta de donde se encuntra nuetra base de datos\n",
    "\n",
    "\n",
    "from pathlib import Path\n",
    "\n",
    "BASE_DIR = Path.cwd()\n",
    "\n",
    "RUTA = BASE_DIR / \"Churn.csv\"\n",
    "\n",
    "df = pd.read_csv(RUTA)\n",
    "df.head()\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "b49cc328",
   "metadata": {},
   "source": [
    "#### üëÄ 2.2 Vista general del DataFrame\n",
    "\n",
    "En esta secci√≥n revisamos:\n",
    "\n",
    "- Tipos de datos.\n",
    "- Presencia de valores nulos.\n",
    "- Tama√±o del dataset.\n",
    "\n",
    "Los datos que tenemos en nuestro DataFrame parecen estar bien, lo que me nos puede resualtar un poco inquietante son los valores nulos.\n",
    "\n",
    "Por otro lado tendremos que quitar `RowNumer` ya que podemos trabajar con el indice, nuesta,  columna objetivo `Exited` esta en **float** por lo que tenemos que cambiarla a int porque no tiene decimales."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 52,
   "id": "fe3b2b64",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "<class 'pandas.core.frame.DataFrame'>\n",
      "RangeIndex: 10000 entries, 0 to 9999\n",
      "Data columns (total 14 columns):\n",
      " #   Column           Non-Null Count  Dtype  \n",
      "---  ------           --------------  -----  \n",
      " 0   RowNumber        10000 non-null  int64  \n",
      " 1   CustomerId       10000 non-null  int64  \n",
      " 2   Surname          10000 non-null  object \n",
      " 3   CreditScore      10000 non-null  int64  \n",
      " 4   Geography        10000 non-null  object \n",
      " 5   Gender           10000 non-null  object \n",
      " 6   Age              10000 non-null  int64  \n",
      " 7   Tenure           9091 non-null   float64\n",
      " 8   Balance          10000 non-null  float64\n",
      " 9   NumOfProducts    10000 non-null  int64  \n",
      " 10  HasCrCard        10000 non-null  int64  \n",
      " 11  IsActiveMember   10000 non-null  int64  \n",
      " 12  EstimatedSalary  10000 non-null  float64\n",
      " 13  Exited           10000 non-null  int64  \n",
      "dtypes: float64(3), int64(8), object(3)\n",
      "memory usage: 1.1+ MB\n"
     ]
    }
   ],
   "source": [
    "df.info()"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4f753c8a",
   "metadata": {},
   "source": [
    "### üîç 3. An√°lisis exploratorio inicial\n",
    "\n",
    "#### 3.1 Revisi√≥n de valores nulos en `Tenure`\n",
    "\n",
    "La columna `Tenure` tiene valores nulos. Queremos entender:\n",
    "\n",
    "- ¬øCu√°ntos faltan?\n",
    "- ¬øQu√© porcentaje representan?\n",
    "- ¬øSi hay alg√∫n patr√≥n en esos registros?\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "1dcd91c3",
   "metadata": {},
   "source": [
    "Los datos nulos tenemos 909 que es un 9.09% de los datos"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 53,
   "id": "0ef7617f",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Valores nulos en Tenure: 909\n",
      "Porcentaje de nulos en Tenure: 9.09%\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>RowNumber</th>\n",
       "      <th>CustomerId</th>\n",
       "      <th>Surname</th>\n",
       "      <th>CreditScore</th>\n",
       "      <th>Geography</th>\n",
       "      <th>Gender</th>\n",
       "      <th>Age</th>\n",
       "      <th>Tenure</th>\n",
       "      <th>Balance</th>\n",
       "      <th>NumOfProducts</th>\n",
       "      <th>HasCrCard</th>\n",
       "      <th>IsActiveMember</th>\n",
       "      <th>EstimatedSalary</th>\n",
       "      <th>Exited</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>30</th>\n",
       "      <td>31</td>\n",
       "      <td>15589475</td>\n",
       "      <td>Azikiwe</td>\n",
       "      <td>591</td>\n",
       "      <td>Spain</td>\n",
       "      <td>Female</td>\n",
       "      <td>39</td>\n",
       "      <td>NaN</td>\n",
       "      <td>0.00</td>\n",
       "      <td>3</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>140469.38</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>48</th>\n",
       "      <td>49</td>\n",
       "      <td>15766205</td>\n",
       "      <td>Yin</td>\n",
       "      <td>550</td>\n",
       "      <td>Germany</td>\n",
       "      <td>Male</td>\n",
       "      <td>38</td>\n",
       "      <td>NaN</td>\n",
       "      <td>103391.38</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>90878.13</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>51</th>\n",
       "      <td>52</td>\n",
       "      <td>15768193</td>\n",
       "      <td>Trevisani</td>\n",
       "      <td>585</td>\n",
       "      <td>Germany</td>\n",
       "      <td>Male</td>\n",
       "      <td>36</td>\n",
       "      <td>NaN</td>\n",
       "      <td>146050.97</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>86424.57</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>53</th>\n",
       "      <td>54</td>\n",
       "      <td>15702298</td>\n",
       "      <td>Parkhill</td>\n",
       "      <td>655</td>\n",
       "      <td>Germany</td>\n",
       "      <td>Male</td>\n",
       "      <td>41</td>\n",
       "      <td>NaN</td>\n",
       "      <td>125561.97</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>164040.94</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>60</th>\n",
       "      <td>61</td>\n",
       "      <td>15651280</td>\n",
       "      <td>Hunter</td>\n",
       "      <td>742</td>\n",
       "      <td>Germany</td>\n",
       "      <td>Male</td>\n",
       "      <td>35</td>\n",
       "      <td>NaN</td>\n",
       "      <td>136857.00</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>84509.57</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "    RowNumber  CustomerId    Surname  CreditScore Geography  Gender  Age  \\\n",
       "30         31    15589475    Azikiwe          591     Spain  Female   39   \n",
       "48         49    15766205        Yin          550   Germany    Male   38   \n",
       "51         52    15768193  Trevisani          585   Germany    Male   36   \n",
       "53         54    15702298   Parkhill          655   Germany    Male   41   \n",
       "60         61    15651280     Hunter          742   Germany    Male   35   \n",
       "\n",
       "    Tenure    Balance  NumOfProducts  HasCrCard  IsActiveMember  \\\n",
       "30     NaN       0.00              3          1               0   \n",
       "48     NaN  103391.38              1          0               1   \n",
       "51     NaN  146050.97              2          0               0   \n",
       "53     NaN  125561.97              1          0               0   \n",
       "60     NaN  136857.00              1          0               0   \n",
       "\n",
       "    EstimatedSalary  Exited  \n",
       "30        140469.38       1  \n",
       "48         90878.13       0  \n",
       "51         86424.57       0  \n",
       "53        164040.94       1  \n",
       "60         84509.57       0  "
      ]
     },
     "execution_count": 53,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# Contamos los valores nuelos de la columna \"Tenure\"\n",
    "tenure_na_count = df[\"Tenure\"].isna().sum()\n",
    "# Sacamos el porcentaje de los valores nuelos de la columna \"Tenure\"\n",
    "tenure_na_ratio = df[\"Tenure\"].isna().mean() * 100\n",
    "\n",
    "# Imprimimos los resultados\n",
    "print(\"Valores nulos en Tenure:\", tenure_na_count)\n",
    "print(\"Porcentaje de nulos en Tenure: {:.2f}%\".format(tenure_na_ratio))\n",
    "\n",
    "# Filtamos los valores nulos para ver si hya alguna similitud de manera visual\n",
    "df_null = df[df[\"Tenure\"].isna()]\n",
    "# Filtamos los valores 0 para ver si hya alguna similitud con los valores nuelos\n",
    "df_zero = df[df[\"Tenure\"] == 1]\n",
    "\n",
    "df_null.head()\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 54,
   "id": "83709fb3",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>RowNumber</th>\n",
       "      <th>CustomerId</th>\n",
       "      <th>Surname</th>\n",
       "      <th>CreditScore</th>\n",
       "      <th>Geography</th>\n",
       "      <th>Gender</th>\n",
       "      <th>Age</th>\n",
       "      <th>Tenure</th>\n",
       "      <th>Balance</th>\n",
       "      <th>NumOfProducts</th>\n",
       "      <th>HasCrCard</th>\n",
       "      <th>IsActiveMember</th>\n",
       "      <th>EstimatedSalary</th>\n",
       "      <th>Exited</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2</td>\n",
       "      <td>15647311</td>\n",
       "      <td>Hill</td>\n",
       "      <td>608</td>\n",
       "      <td>Spain</td>\n",
       "      <td>Female</td>\n",
       "      <td>41</td>\n",
       "      <td>1.0</td>\n",
       "      <td>83807.86</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>112542.58</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>4</td>\n",
       "      <td>15701354</td>\n",
       "      <td>Boni</td>\n",
       "      <td>699</td>\n",
       "      <td>France</td>\n",
       "      <td>Female</td>\n",
       "      <td>39</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.00</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>93826.63</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>16</th>\n",
       "      <td>17</td>\n",
       "      <td>15737452</td>\n",
       "      <td>Romeo</td>\n",
       "      <td>653</td>\n",
       "      <td>Germany</td>\n",
       "      <td>Male</td>\n",
       "      <td>58</td>\n",
       "      <td>1.0</td>\n",
       "      <td>132602.88</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>5097.67</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>54</th>\n",
       "      <td>55</td>\n",
       "      <td>15569590</td>\n",
       "      <td>Yoo</td>\n",
       "      <td>601</td>\n",
       "      <td>Germany</td>\n",
       "      <td>Male</td>\n",
       "      <td>42</td>\n",
       "      <td>1.0</td>\n",
       "      <td>98495.72</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>40014.76</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>55</th>\n",
       "      <td>56</td>\n",
       "      <td>15760861</td>\n",
       "      <td>Phillipps</td>\n",
       "      <td>619</td>\n",
       "      <td>France</td>\n",
       "      <td>Male</td>\n",
       "      <td>43</td>\n",
       "      <td>1.0</td>\n",
       "      <td>125211.92</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>113410.49</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>62</th>\n",
       "      <td>63</td>\n",
       "      <td>15702014</td>\n",
       "      <td>Jeffrey</td>\n",
       "      <td>555</td>\n",
       "      <td>Spain</td>\n",
       "      <td>Male</td>\n",
       "      <td>33</td>\n",
       "      <td>1.0</td>\n",
       "      <td>56084.69</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>178798.13</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>66</th>\n",
       "      <td>67</td>\n",
       "      <td>15696061</td>\n",
       "      <td>Brownless</td>\n",
       "      <td>581</td>\n",
       "      <td>Germany</td>\n",
       "      <td>Female</td>\n",
       "      <td>34</td>\n",
       "      <td>1.0</td>\n",
       "      <td>101633.04</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>110431.51</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>75</th>\n",
       "      <td>76</td>\n",
       "      <td>15780961</td>\n",
       "      <td>Cavenagh</td>\n",
       "      <td>735</td>\n",
       "      <td>France</td>\n",
       "      <td>Female</td>\n",
       "      <td>21</td>\n",
       "      <td>1.0</td>\n",
       "      <td>178718.19</td>\n",
       "      <td>2</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>22388.00</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>80</th>\n",
       "      <td>81</td>\n",
       "      <td>15706021</td>\n",
       "      <td>Buley</td>\n",
       "      <td>665</td>\n",
       "      <td>France</td>\n",
       "      <td>Female</td>\n",
       "      <td>34</td>\n",
       "      <td>1.0</td>\n",
       "      <td>96645.54</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>171413.66</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>104</th>\n",
       "      <td>105</td>\n",
       "      <td>15804919</td>\n",
       "      <td>Dunbabin</td>\n",
       "      <td>670</td>\n",
       "      <td>Spain</td>\n",
       "      <td>Female</td>\n",
       "      <td>65</td>\n",
       "      <td>1.0</td>\n",
       "      <td>0.00</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>177655.68</td>\n",
       "      <td>1</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "     RowNumber  CustomerId    Surname  CreditScore Geography  Gender  Age  \\\n",
       "1            2    15647311       Hill          608     Spain  Female   41   \n",
       "3            4    15701354       Boni          699    France  Female   39   \n",
       "16          17    15737452      Romeo          653   Germany    Male   58   \n",
       "54          55    15569590        Yoo          601   Germany    Male   42   \n",
       "55          56    15760861  Phillipps          619    France    Male   43   \n",
       "62          63    15702014    Jeffrey          555     Spain    Male   33   \n",
       "66          67    15696061  Brownless          581   Germany  Female   34   \n",
       "75          76    15780961   Cavenagh          735    France  Female   21   \n",
       "80          81    15706021      Buley          665    France  Female   34   \n",
       "104        105    15804919   Dunbabin          670     Spain  Female   65   \n",
       "\n",
       "     Tenure    Balance  NumOfProducts  HasCrCard  IsActiveMember  \\\n",
       "1       1.0   83807.86              1          0               1   \n",
       "3       1.0       0.00              2          0               0   \n",
       "16      1.0  132602.88              1          1               0   \n",
       "54      1.0   98495.72              1          1               0   \n",
       "55      1.0  125211.92              1          1               1   \n",
       "62      1.0   56084.69              2          0               0   \n",
       "66      1.0  101633.04              1          1               0   \n",
       "75      1.0  178718.19              2          1               0   \n",
       "80      1.0   96645.54              2          0               0   \n",
       "104     1.0       0.00              1          1               1   \n",
       "\n",
       "     EstimatedSalary  Exited  \n",
       "1          112542.58       0  \n",
       "3           93826.63       0  \n",
       "16           5097.67       1  \n",
       "54          40014.76       1  \n",
       "55         113410.49       0  \n",
       "62         178798.13       0  \n",
       "66         110431.51       0  \n",
       "75          22388.00       0  \n",
       "80         171413.66       0  \n",
       "104        177655.68       1  "
      ]
     },
     "execution_count": 54,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# Mostramos los peremos 10 de las personas que se han ido del banco.\n",
    "df_zero.head(10)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "f742c592",
   "metadata": {},
   "source": [
    "No encontramos ningun posible patron visual que podamos crear una hipotesis por lo que mas adelate dividiremos los valores nulos para ver si estan relacionados con posible churn."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "4945b309",
   "metadata": {},
   "source": [
    "#### üìä 3.2 Estad√≠sticos descriptivos\n",
    "\n",
    "Revisamos la distribuci√≥n de las variables num√©ricas para detectar rangos, posibles valores at√≠picos y entender el comportamiento general de los clientes y formular posibles hipotesis de los datos.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 55,
   "id": "bc028fe7",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>RowNumber</th>\n",
       "      <th>CustomerId</th>\n",
       "      <th>CreditScore</th>\n",
       "      <th>Age</th>\n",
       "      <th>Tenure</th>\n",
       "      <th>Balance</th>\n",
       "      <th>NumOfProducts</th>\n",
       "      <th>HasCrCard</th>\n",
       "      <th>IsActiveMember</th>\n",
       "      <th>EstimatedSalary</th>\n",
       "      <th>Exited</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>count</th>\n",
       "      <td>10000.00000</td>\n",
       "      <td>1.000000e+04</td>\n",
       "      <td>10000.000000</td>\n",
       "      <td>10000.000000</td>\n",
       "      <td>9091.000000</td>\n",
       "      <td>10000.000000</td>\n",
       "      <td>10000.000000</td>\n",
       "      <td>10000.00000</td>\n",
       "      <td>10000.000000</td>\n",
       "      <td>10000.000000</td>\n",
       "      <td>10000.000000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>mean</th>\n",
       "      <td>5000.50000</td>\n",
       "      <td>1.569094e+07</td>\n",
       "      <td>650.528800</td>\n",
       "      <td>38.921800</td>\n",
       "      <td>4.997690</td>\n",
       "      <td>76485.889288</td>\n",
       "      <td>1.530200</td>\n",
       "      <td>0.70550</td>\n",
       "      <td>0.515100</td>\n",
       "      <td>100090.239881</td>\n",
       "      <td>0.203700</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>std</th>\n",
       "      <td>2886.89568</td>\n",
       "      <td>7.193619e+04</td>\n",
       "      <td>96.653299</td>\n",
       "      <td>10.487806</td>\n",
       "      <td>2.894723</td>\n",
       "      <td>62397.405202</td>\n",
       "      <td>0.581654</td>\n",
       "      <td>0.45584</td>\n",
       "      <td>0.499797</td>\n",
       "      <td>57510.492818</td>\n",
       "      <td>0.402769</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>min</th>\n",
       "      <td>1.00000</td>\n",
       "      <td>1.556570e+07</td>\n",
       "      <td>350.000000</td>\n",
       "      <td>18.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>1.000000</td>\n",
       "      <td>0.00000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>11.580000</td>\n",
       "      <td>0.000000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>25%</th>\n",
       "      <td>2500.75000</td>\n",
       "      <td>1.562853e+07</td>\n",
       "      <td>584.000000</td>\n",
       "      <td>32.000000</td>\n",
       "      <td>2.000000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>1.000000</td>\n",
       "      <td>0.00000</td>\n",
       "      <td>0.000000</td>\n",
       "      <td>51002.110000</td>\n",
       "      <td>0.000000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>50%</th>\n",
       "      <td>5000.50000</td>\n",
       "      <td>1.569074e+07</td>\n",
       "      <td>652.000000</td>\n",
       "      <td>37.000000</td>\n",
       "      <td>5.000000</td>\n",
       "      <td>97198.540000</td>\n",
       "      <td>1.000000</td>\n",
       "      <td>1.00000</td>\n",
       "      <td>1.000000</td>\n",
       "      <td>100193.915000</td>\n",
       "      <td>0.000000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>75%</th>\n",
       "      <td>7500.25000</td>\n",
       "      <td>1.575323e+07</td>\n",
       "      <td>718.000000</td>\n",
       "      <td>44.000000</td>\n",
       "      <td>7.000000</td>\n",
       "      <td>127644.240000</td>\n",
       "      <td>2.000000</td>\n",
       "      <td>1.00000</td>\n",
       "      <td>1.000000</td>\n",
       "      <td>149388.247500</td>\n",
       "      <td>0.000000</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>max</th>\n",
       "      <td>10000.00000</td>\n",
       "      <td>1.581569e+07</td>\n",
       "      <td>850.000000</td>\n",
       "      <td>92.000000</td>\n",
       "      <td>10.000000</td>\n",
       "      <td>250898.090000</td>\n",
       "      <td>4.000000</td>\n",
       "      <td>1.00000</td>\n",
       "      <td>1.000000</td>\n",
       "      <td>199992.480000</td>\n",
       "      <td>1.000000</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "         RowNumber    CustomerId   CreditScore           Age       Tenure  \\\n",
       "count  10000.00000  1.000000e+04  10000.000000  10000.000000  9091.000000   \n",
       "mean    5000.50000  1.569094e+07    650.528800     38.921800     4.997690   \n",
       "std     2886.89568  7.193619e+04     96.653299     10.487806     2.894723   \n",
       "min        1.00000  1.556570e+07    350.000000     18.000000     0.000000   \n",
       "25%     2500.75000  1.562853e+07    584.000000     32.000000     2.000000   \n",
       "50%     5000.50000  1.569074e+07    652.000000     37.000000     5.000000   \n",
       "75%     7500.25000  1.575323e+07    718.000000     44.000000     7.000000   \n",
       "max    10000.00000  1.581569e+07    850.000000     92.000000    10.000000   \n",
       "\n",
       "             Balance  NumOfProducts    HasCrCard  IsActiveMember  \\\n",
       "count   10000.000000   10000.000000  10000.00000    10000.000000   \n",
       "mean    76485.889288       1.530200      0.70550        0.515100   \n",
       "std     62397.405202       0.581654      0.45584        0.499797   \n",
       "min         0.000000       1.000000      0.00000        0.000000   \n",
       "25%         0.000000       1.000000      0.00000        0.000000   \n",
       "50%     97198.540000       1.000000      1.00000        1.000000   \n",
       "75%    127644.240000       2.000000      1.00000        1.000000   \n",
       "max    250898.090000       4.000000      1.00000        1.000000   \n",
       "\n",
       "       EstimatedSalary        Exited  \n",
       "count     10000.000000  10000.000000  \n",
       "mean     100090.239881      0.203700  \n",
       "std       57510.492818      0.402769  \n",
       "min          11.580000      0.000000  \n",
       "25%       51002.110000      0.000000  \n",
       "50%      100193.915000      0.000000  \n",
       "75%      149388.247500      0.000000  \n",
       "max      199992.480000      1.000000  "
      ]
     },
     "execution_count": 55,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "df.describe()\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "460ba778",
   "metadata": {},
   "source": [
    "Tendremos que escalar las columnas `CreditScore`, `Balance`, `EstimatedSalary` par  que todas las columnas esten en la misma escala."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "668faead",
   "metadata": {},
   "source": [
    "#### 3.3 Duplicados\n",
    "\n",
    "Comprobamos si hay filas duplicadas en el dataset, tanto a nivel de fila completa como por `CustomerId`.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 56,
   "id": "d5fb2f24",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "0\n",
      "0\n"
     ]
    }
   ],
   "source": [
    "print(df.duplicated().sum())\n",
    "print(df.duplicated(\"CustomerId\").sum())\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "2866af86",
   "metadata": {},
   "source": [
    "No se encontraron ningun valor duplicado por lo que podemos proceder a la preparacion de los datos."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "7f8a5ea2",
   "metadata": {},
   "source": [
    "### üßπ 4. Preparaci√≥n y preprocesamiento de datos\n",
    "\n",
    "#### 4.1 Manejo de valores faltantes en `Tenure`\n",
    "\n",
    "Suposici√≥n de trabajo:\n",
    "- `Tenure` representa la antig√ºedad del cliente.\n",
    "- No encontramos evidencia clara de que los nulos correspondan solo a clientes nuevos.\n",
    "- Para no perder registros, remplasamos con la **mediana** y marcamos qu√© registros ten√≠an nulo originalmente.\n",
    "\n",
    "Creamos la columna binaria `TenureWasMissing` para capturar ese posible efecto siguiendo la nomenclatura de las columnas.\n",
    "\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d8a68173",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>Tenure</th>\n",
       "      <th>TenureWasMissing</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>2.0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>1.0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>8.0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>1.0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>2.0</td>\n",
       "      <td>0</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   Tenure  TenureWasMissing\n",
       "0     2.0                 0\n",
       "1     1.0                 0\n",
       "2     8.0                 0\n",
       "3     1.0                 0\n",
       "4     2.0                 0"
      ]
     },
     "execution_count": 57,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "\n",
    "# Marcamos d√≥nde faltaba Tenure\n",
    "df[\"TenureWasMissing\"] = df[\"Tenure\"].isna().astype(int)\n",
    "\n",
    "# Calculamos la mediana solo con valores existentes\n",
    "tenure_median = df[\"Tenure\"].median()\n",
    "\n",
    "# Rempalzamos Tenure con la mediana\n",
    "df[\"Tenure\"] = df[\"Tenure\"].fillna(tenure_median)\n",
    "\n",
    "# Mostramos las primeras filas\n",
    "df[[\"Tenure\", \"TenureWasMissing\"]].head()\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "65686a98",
   "metadata": {},
   "source": [
    "#### 4.2 Ajuste de tipos de datos\n",
    "\n",
    "Convertimos las columnas num√©ricas a los tipos adecuados (`int` o `float`) para evitar problemas en el modelado.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "842da1f4",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "RowNumber             int64\n",
       "CustomerId            int64\n",
       "Surname              object\n",
       "CreditScore           int64\n",
       "Geography            object\n",
       "Gender               object\n",
       "Age                   int64\n",
       "Tenure              float64\n",
       "Balance             float64\n",
       "NumOfProducts         int64\n",
       "HasCrCard             int64\n",
       "IsActiveMember        int64\n",
       "EstimatedSalary     float64\n",
       "Exited                int64\n",
       "TenureWasMissing      int64\n",
       "dtype: object"
      ]
     },
     "execution_count": 58,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# Enlistamos los tipos de datos pro clolumna (Feature) \n",
    "df.dtypes\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "7426d5c7",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/plain": [
       "RowNumber             int64\n",
       "CustomerId            int64\n",
       "Surname              object\n",
       "CreditScore           int64\n",
       "Geography            object\n",
       "Gender               object\n",
       "Age                   int64\n",
       "Tenure                int64\n",
       "Balance             float64\n",
       "NumOfProducts         int64\n",
       "HasCrCard             int64\n",
       "IsActiveMember        int64\n",
       "EstimatedSalary     float64\n",
       "Exited                int64\n",
       "TenureWasMissing      int64\n",
       "dtype: object"
      ]
     },
     "execution_count": 59,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# Seleccionamos las caracteristicas que queremos convertir a float \n",
    "col_float = [\"Balance\", \n",
    "             \"EstimatedSalary\"\n",
    "             ]\n",
    "\n",
    "# Seleccionamos las caracteristicas que queremos convertir a int\n",
    "# algunos datos ya se encontraban en ese tipo de dato aun asi los incluimos para estar seguros\n",
    "\n",
    "col_int = [\n",
    "    \"RowNumber\",\n",
    "    \"CreditScore\",\n",
    "    \"Age\",\n",
    "    \"Tenure\",\n",
    "    \"NumOfProducts\",\n",
    "    \"HasCrCard\",\n",
    "    \"IsActiveMember\",\n",
    "    \"Exited\"\n",
    "]\n",
    "\n",
    "# Convertimos las caracteristicas al tipo de dato seleccionado anterior mente\n",
    "df[col_float] = df[col_float].astype(float)\n",
    "df[col_int] = df[col_int].astype(int)\n",
    "\n",
    "df.dtypes\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "e637291a",
   "metadata": {},
   "source": [
    "#### 4.3 Codificaci√≥n de variables categ√≥ricas (One-Hot Encoding)\n",
    "\n",
    "Variables categ√≥ricas a codificar:\n",
    "\n",
    "- `Geography`\n",
    "- `Gender`\n",
    "\n",
    "Usamos **One-Hot Encoding** con `drop_first=True` para evitar multicolinealidad perfecta.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "1625dc8c",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>RowNumber</th>\n",
       "      <th>CustomerId</th>\n",
       "      <th>Surname</th>\n",
       "      <th>CreditScore</th>\n",
       "      <th>Age</th>\n",
       "      <th>Tenure</th>\n",
       "      <th>Balance</th>\n",
       "      <th>NumOfProducts</th>\n",
       "      <th>HasCrCard</th>\n",
       "      <th>IsActiveMember</th>\n",
       "      <th>EstimatedSalary</th>\n",
       "      <th>Exited</th>\n",
       "      <th>TenureWasMissing</th>\n",
       "      <th>Geography_Germany</th>\n",
       "      <th>Geography_Spain</th>\n",
       "      <th>Gender_Male</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>1</td>\n",
       "      <td>15634602</td>\n",
       "      <td>Hargrave</td>\n",
       "      <td>619</td>\n",
       "      <td>42</td>\n",
       "      <td>2</td>\n",
       "      <td>0.00</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>101348.88</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>False</td>\n",
       "      <td>False</td>\n",
       "      <td>False</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>2</td>\n",
       "      <td>15647311</td>\n",
       "      <td>Hill</td>\n",
       "      <td>608</td>\n",
       "      <td>41</td>\n",
       "      <td>1</td>\n",
       "      <td>83807.86</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>1</td>\n",
       "      <td>112542.58</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>False</td>\n",
       "      <td>True</td>\n",
       "      <td>False</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>3</td>\n",
       "      <td>15619304</td>\n",
       "      <td>Onio</td>\n",
       "      <td>502</td>\n",
       "      <td>42</td>\n",
       "      <td>8</td>\n",
       "      <td>159660.80</td>\n",
       "      <td>3</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>113931.57</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>False</td>\n",
       "      <td>False</td>\n",
       "      <td>False</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>4</td>\n",
       "      <td>15701354</td>\n",
       "      <td>Boni</td>\n",
       "      <td>699</td>\n",
       "      <td>39</td>\n",
       "      <td>1</td>\n",
       "      <td>0.00</td>\n",
       "      <td>2</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>93826.63</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>False</td>\n",
       "      <td>False</td>\n",
       "      <td>False</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>5</td>\n",
       "      <td>15737888</td>\n",
       "      <td>Mitchell</td>\n",
       "      <td>850</td>\n",
       "      <td>43</td>\n",
       "      <td>2</td>\n",
       "      <td>125510.82</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>79084.10</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>False</td>\n",
       "      <td>True</td>\n",
       "      <td>False</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "   RowNumber  CustomerId   Surname  CreditScore  Age  Tenure    Balance  \\\n",
       "0          1    15634602  Hargrave          619   42       2       0.00   \n",
       "1          2    15647311      Hill          608   41       1   83807.86   \n",
       "2          3    15619304      Onio          502   42       8  159660.80   \n",
       "3          4    15701354      Boni          699   39       1       0.00   \n",
       "4          5    15737888  Mitchell          850   43       2  125510.82   \n",
       "\n",
       "   NumOfProducts  HasCrCard  IsActiveMember  EstimatedSalary  Exited  \\\n",
       "0              1          1               1        101348.88       1   \n",
       "1              1          0               1        112542.58       0   \n",
       "2              3          1               0        113931.57       1   \n",
       "3              2          0               0         93826.63       0   \n",
       "4              1          1               1         79084.10       0   \n",
       "\n",
       "   TenureWasMissing  Geography_Germany  Geography_Spain  Gender_Male  \n",
       "0                 0              False            False        False  \n",
       "1                 0              False             True        False  \n",
       "2                 0              False            False        False  \n",
       "3                 0              False            False        False  \n",
       "4                 0              False             True        False  "
      ]
     },
     "execution_count": 60,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# seleccionamos las columnas las cuales queremos aplicarle OHE\n",
    "col_ohe = [\"Geography\", \"Gender\"]\n",
    "\n",
    "# Quitamos una de las columnas para evitar multicolinealidad perfecta\n",
    "dummies = pd.get_dummies(df[col_ohe], drop_first=True)\n",
    "\n",
    "# Quitamos las columnas originales para evitar duplicidad de datos\n",
    "df_num = df.drop(columns=col_ohe)\n",
    "\n",
    "# Unimos las nuevas columnas a unetro data set\n",
    "df_prepared = pd.concat([df_num, dummies], axis=1)\n",
    "\n",
    "# comprobamos como quedo nuestro data set despues de la codificacion OHE\n",
    "df_prepared.head()\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "058cbe47",
   "metadata": {},
   "source": [
    "### ‚öñÔ∏è 5. An√°lisis del equilibrio de clases\n",
    "\n",
    "Revisamos la distribuci√≥n de la variable objetivo `Exited`:\n",
    "\n",
    "- `1` ‚Üí el cliente se fue.\n",
    "- `0` ‚Üí el cliente se qued√≥.\n",
    "\n",
    "Esto nos indica si el problema est√° desbalanceado.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "c237b81d",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Exited\n",
      "0    7963\n",
      "1    2037\n",
      "Name: count, dtype: int64\n",
      "\n",
      "Porcentaje por clase (%):\n",
      "Exited\n",
      "0    79.63\n",
      "1    20.37\n",
      "Name: proportion, dtype: float64\n"
     ]
    }
   ],
   "source": [
    "# Seleccionamos como la variable objetivo est√° distribuida\n",
    "target_counts = df_prepared[\"Exited\"].value_counts()\n",
    "# Sacamos los porcentajes de la distribucion de la variable objetivo\n",
    "target_ratio = df_prepared[\"Exited\"].value_counts(normalize=True) * 100\n",
    "\n",
    "# Revisamos los resultados\n",
    "print(target_counts)\n",
    "print(\"\\nPorcentaje por clase (%):\")\n",
    "print(target_ratio.round(2))\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "60c06e7b",
   "metadata": {},
   "source": [
    "Esto muestra que aproximadamente 4 de cada 5 clientes se quedan y solo 1 de cada 5 se va, por lo que el problema es claramente desbalanceado a favor de la clase 0.\n",
    "\n",
    "Debido a este desbalance, m√°s adelante apliqu√© upsampling sobre el conjunto de entrenamiento para aumentar la proporci√≥n de la clase minoritaria (Exited = 1) y ayudar al modelo a aprender mejor a detectar a los clientes que abandonan el banco."
   ]
  },
  {
   "cell_type": "markdown",
   "id": "aa3b7f8d",
   "metadata": {},
   "source": [
    "### üìä 6. Divisi√≥n de los datos en conjuntos\n",
    "\n",
    "Usamos un split Train/Valid:\n",
    "\n",
    "- **Train (75%)** ‚Üí entrenamiento y balanceo.\n",
    "- **Valid (25%)** ‚Üí evaluaci√≥n de modelos y tuning de hiperpar√°metros.\n",
    "\n",
    "Escalamos las columnas num√©ricas continuas `CreditScore`, `Balance` y `EstimatedSalary` usando `StandardScaler`."
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 62,
   "id": "92d9b5a7",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "features_train: (7500, 12)\n",
      "features_valid: (2500, 12)\n",
      "target_train: (7500,)\n",
      "target_valid: (2500,)\n"
     ]
    },
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>CreditScore</th>\n",
       "      <th>Age</th>\n",
       "      <th>Tenure</th>\n",
       "      <th>Balance</th>\n",
       "      <th>NumOfProducts</th>\n",
       "      <th>HasCrCard</th>\n",
       "      <th>IsActiveMember</th>\n",
       "      <th>EstimatedSalary</th>\n",
       "      <th>TenureWasMissing</th>\n",
       "      <th>Geography_Germany</th>\n",
       "      <th>Geography_Spain</th>\n",
       "      <th>Gender_Male</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>7770</th>\n",
       "      <td>0.507706</td>\n",
       "      <td>29</td>\n",
       "      <td>3</td>\n",
       "      <td>0.779438</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0.896894</td>\n",
       "      <td>0</td>\n",
       "      <td>False</td>\n",
       "      <td>False</td>\n",
       "      <td>True</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3552</th>\n",
       "      <td>1.890945</td>\n",
       "      <td>39</td>\n",
       "      <td>3</td>\n",
       "      <td>-1.234086</td>\n",
       "      <td>2</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>-1.716892</td>\n",
       "      <td>0</td>\n",
       "      <td>False</td>\n",
       "      <td>False</td>\n",
       "      <td>False</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2141</th>\n",
       "      <td>0.249639</td>\n",
       "      <td>18</td>\n",
       "      <td>7</td>\n",
       "      <td>-1.234086</td>\n",
       "      <td>2</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>-0.774646</td>\n",
       "      <td>0</td>\n",
       "      <td>False</td>\n",
       "      <td>False</td>\n",
       "      <td>True</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8832</th>\n",
       "      <td>1.065131</td>\n",
       "      <td>35</td>\n",
       "      <td>4</td>\n",
       "      <td>-1.234086</td>\n",
       "      <td>2</td>\n",
       "      <td>1</td>\n",
       "      <td>1</td>\n",
       "      <td>0.106717</td>\n",
       "      <td>0</td>\n",
       "      <td>False</td>\n",
       "      <td>False</td>\n",
       "      <td>True</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9693</th>\n",
       "      <td>-0.338753</td>\n",
       "      <td>51</td>\n",
       "      <td>10</td>\n",
       "      <td>1.445615</td>\n",
       "      <td>1</td>\n",
       "      <td>0</td>\n",
       "      <td>0</td>\n",
       "      <td>-0.117565</td>\n",
       "      <td>0</td>\n",
       "      <td>True</td>\n",
       "      <td>False</td>\n",
       "      <td>False</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "      CreditScore  Age  Tenure   Balance  NumOfProducts  HasCrCard  \\\n",
       "7770     0.507706   29       3  0.779438              1          1   \n",
       "3552     1.890945   39       3 -1.234086              2          1   \n",
       "2141     0.249639   18       7 -1.234086              2          1   \n",
       "8832     1.065131   35       4 -1.234086              2          1   \n",
       "9693    -0.338753   51      10  1.445615              1          0   \n",
       "\n",
       "      IsActiveMember  EstimatedSalary  TenureWasMissing  Geography_Germany  \\\n",
       "7770               1         0.896894                 0              False   \n",
       "3552               0        -1.716892                 0              False   \n",
       "2141               1        -0.774646                 0              False   \n",
       "8832               1         0.106717                 0              False   \n",
       "9693               0        -0.117565                 0               True   \n",
       "\n",
       "      Geography_Spain  Gender_Male  \n",
       "7770            False         True  \n",
       "3552            False        False  \n",
       "2141            False         True  \n",
       "8832            False         True  \n",
       "9693            False        False  "
      ]
     },
     "execution_count": 62,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "# Seleccionamos las columnas que pueden causar problemas en nuestros modelos. \n",
    "col_drop = [\"RowNumber\", \"Surname\", \"Exited\", \"CustomerId\"]\n",
    "\n",
    "# Quitamos las columnas.\n",
    "features = df_prepared.drop(columns=col_drop, axis=1)\n",
    "target = df_prepared[\"Exited\"]\n",
    "\n",
    "# Dividomos nuestro modelo con 75% para el test y 25 % para la validaci√≥n.\n",
    "features_train, features_valid, target_train, target_valid = train_test_split(\n",
    "    features,\n",
    "    target,\n",
    "    test_size=0.25,\n",
    "    random_state=RANDOM_STATE\n",
    ")\n",
    "\n",
    "# Imprimimos el tama√±o de cada conjunto para ver que la divisi√≥n se halla realizado con √©xito.\n",
    "print(\"features_train:\", features_train.shape)\n",
    "print(\"features_valid:\", features_valid.shape)\n",
    "print(\"target_train:\", target_train.shape)\n",
    "print(\"target_valid:\", target_valid.shape)\n",
    "\n",
    "\n",
    "# ==========================\n",
    "# Escalado de caracter√≠sticas\n",
    "# ==========================\n",
    "\n",
    "# Columnas num√©ricas continuas a escalar.\n",
    "# No se incluyen las otras ya que se encuentan en una escala similar.\n",
    "cols_to_scale = [\n",
    "    \"CreditScore\",\n",
    "    \"Balance\",\n",
    "    \"EstimatedSalary\"\n",
    "]\n",
    "\n",
    "scaler = StandardScaler()\n",
    "\n",
    "# Ajustamos el scaler SOLO con los datos de entrenamiento\n",
    "features_train_scaled = features_train.copy()\n",
    "features_valid_scaled = features_valid.copy()\n",
    "\n",
    "features_train_scaled[cols_to_scale] = scaler.fit_transform(features_train[cols_to_scale])\n",
    "features_valid_scaled[cols_to_scale] = scaler.transform(features_valid[cols_to_scale])\n",
    "\n",
    "# Imprimimos para verificar como quedo el escalado de los datos. \n",
    "features_train_scaled.head()\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "d8ed0da0",
   "metadata": {},
   "source": [
    "### ‚öñÔ∏è 7. Balanceo de clases (Upsampling)\n",
    "\n",
    "El conjunto de entrenamiento est√° desbalanceado.  \n",
    "Para que el modelo aprenda mejor la clase minoritaria (`Exited = 1`), usamos **upsampling** sobre el conjunto de entrenamiento:\n",
    "\n",
    "- Repetimos varias veces las filas de la clase minoritaria.\n",
    "- Mezclamos (`shuffle`) para no introducir orden artificial.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "a2f355a8",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Tama√±o original (train): 7500\n",
      "Tama√±o tras upsampling: 10618\n",
      "\n",
      "Distribuci√≥n tras upsampling:\n",
      "Exited\n",
      "0    5941\n",
      "1    4677\n",
      "Name: count, dtype: int64\n"
     ]
    }
   ],
   "source": [
    "# 7.1 Funcion para hacer sobre muestreo de las varibles\n",
    "\n",
    "# Definimos las variables que necesitamos dentro de los () \n",
    "def upsample(features, target, repeat, random_state=RANDOM_STATE):\n",
    "    features_zeros = features[target == 0]\n",
    "    features_ones = features[target == 1]\n",
    "    target_zeros = target[target == 0]\n",
    "    target_ones = target[target == 1]\n",
    "# Juntamos los datos sobremuestrados \n",
    "    features_upsampled = pd.concat([features_zeros] + [features_ones] * repeat)\n",
    "    target_upsampled = pd.concat([target_zeros] + [target_ones] * repeat)\n",
    "\n",
    "# Aplicamos aleatoridad a nuestros datos\n",
    "    features_upsampled, target_upsampled = shuffle(\n",
    "        features_upsampled,\n",
    "        target_upsampled,\n",
    "        random_state=random_state\n",
    "    )\n",
    "    return features_upsampled, target_upsampled\n",
    "\n",
    "# Multiplicamos por 3 para acercanos lo mayor posinble a el tama√±o de nuestra variable dominante.\n",
    "repeat = 3\n",
    "features_upsampled, target_upsampled = upsample(\n",
    "    features_train_scaled,\n",
    "    target_train,\n",
    "    repeat\n",
    ")\n",
    "\n",
    "# Revisamos los resultados\n",
    "print(\"Tama√±o original (train):\", target_train.shape[0])\n",
    "print(\"Tama√±o tras upsampling:\", target_upsampled.shape[0])\n",
    "print(\"\\nDistribuci√≥n tras upsampling:\")\n",
    "print(target_upsampled.value_counts())\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "3401d801",
   "metadata": {},
   "source": [
    "A partir de aqu√≠, en TODO lo que sigue, usa:\n",
    "\n",
    "`features_upsampled` / `target_upsampled` para entrenar.\n",
    "\n",
    "`features_valid_scaled` / `target_valid` para validar.\n",
    "\n",
    "---"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "cead20e5",
   "metadata": {},
   "source": [
    "### üß™ 8. Modelo base (sin tuning) ‚Äì DecisionTreeClassifier\n",
    "\n",
    "Primero entrenamos un **modelo base simple** con `DecisionTreeClassifier`  \n",
    "usando directamente el conjunto de entrenamiento original (sin balanceo) para tener una referencia.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "d997ddb7",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "F1 modelo base (√°rbol simple): 0.5177304964539007\n",
      "AUC-ROC (basado en predicci√≥n binaria): 0.6922347896982564\n"
     ]
    }
   ],
   "source": [
    "# 8.1 entrenamos nuestro modelo base\n",
    "tree_base = DecisionTreeClassifier(\n",
    "    random_state=RANDOM_STATE,\n",
    "    max_depth=2\n",
    ")\n",
    "\n",
    "# Se usara el train normal (escalado), sin upsampling.\n",
    "tree_base.fit(features_train_scaled, target_train)\n",
    "base_tree_pred = tree_base.predict(features_valid_scaled)\n",
    "\n",
    "print(\"F1 modelo base (√°rbol simple):\", f1_score(target_valid, base_tree_pred))\n",
    "\n",
    "# AUC-ROC (si lo dejas as√≠, sigue usando etiquetas; ver punto 2 para mejorarlo)\n",
    "print(\"AUC-ROC (basado en predicci√≥n binaria):\", roc_auc_score(target_valid, base_tree_pred))\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "db245bea",
   "metadata": {},
   "source": [
    "### ‚öôÔ∏è 9. B√∫squeda de hiperpar√°metros\n",
    "\n",
    "Probamos distintos modelos y configuraciones usando el conjunto **upsampled**:\n",
    "\n",
    "- `DecisionTreeClassifier`\n",
    "- `RandomForestClassifier`\n",
    "- `LogisticRegression`\n",
    "\n",
    "Buscamos maximizar **F1** sobre el conjunto de validaci√≥n.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 65,
   "id": "db31f731",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "leafs= 10 , depth= 1 is 0.47959183673469385\n",
      "leafs= 10 , depth= 2 is 0.5126945126945127\n",
      "leafs= 10 , depth= 3 is 0.5301837270341208\n",
      "leafs= 10 , depth= 4 is 0.5228276877761414\n",
      "leafs= 10 , depth= 5 is 0.5834076717216771\n",
      "leafs= 10 , depth= 6 is 0.5595854922279793\n",
      "leafs= 10 , depth= 7 is 0.5789923142613151\n",
      "leafs= 10 , depth= 8 is 0.5977653631284916\n",
      "leafs= 10 , depth= 9 is 0.5437710437710438\n",
      "leafs= 10 , depth= 10 is 0.5563380281690141\n",
      "leafs= 20 , depth= 1 is 0.47959183673469385\n",
      "leafs= 20 , depth= 2 is 0.5126945126945127\n",
      "leafs= 20 , depth= 3 is 0.5301837270341208\n",
      "leafs= 20 , depth= 4 is 0.5228276877761414\n",
      "leafs= 20 , depth= 5 is 0.585278276481149\n",
      "leafs= 20 , depth= 6 is 0.5597624350408315\n",
      "leafs= 20 , depth= 7 is 0.5914260717410323\n",
      "leafs= 20 , depth= 8 is 0.5956678700361011\n",
      "leafs= 20 , depth= 9 is 0.5468227424749164\n",
      "leafs= 20 , depth= 10 is 0.5559322033898305\n",
      "leafs= 30 , depth= 1 is 0.47959183673469385\n",
      "leafs= 30 , depth= 2 is 0.5126945126945127\n",
      "leafs= 30 , depth= 3 is 0.5301837270341208\n",
      "leafs= 30 , depth= 4 is 0.5228276877761414\n",
      "leafs= 30 , depth= 5 is 0.5851917930419268\n",
      "leafs= 30 , depth= 6 is 0.5579655946148093\n",
      "leafs= 30 , depth= 7 is 0.5863874345549738\n",
      "leafs= 30 , depth= 8 is 0.5711878685762426\n",
      "leafs= 30 , depth= 9 is 0.5525846702317291\n",
      "leafs= 30 , depth= 10 is 0.5531547104580813\n",
      "leafs= 40 , depth= 1 is 0.47959183673469385\n",
      "leafs= 40 , depth= 2 is 0.5126945126945127\n",
      "leafs= 40 , depth= 3 is 0.5301837270341208\n",
      "leafs= 40 , depth= 4 is 0.5228276877761414\n",
      "leafs= 40 , depth= 5 is 0.5839929639401935\n",
      "leafs= 40 , depth= 6 is 0.5573033707865168\n",
      "leafs= 40 , depth= 7 is 0.5908289241622575\n",
      "leafs= 40 , depth= 8 is 0.5797598627787307\n",
      "leafs= 40 , depth= 9 is 0.5709090909090909\n",
      "leafs= 40 , depth= 10 is 0.567922874671341\n",
      "leafs= 50 , depth= 1 is 0.47959183673469385\n",
      "leafs= 50 , depth= 2 is 0.5126945126945127\n",
      "leafs= 50 , depth= 3 is 0.5301837270341208\n",
      "leafs= 50 , depth= 4 is 0.5228276877761414\n",
      "leafs= 50 , depth= 5 is 0.5839929639401935\n",
      "leafs= 50 , depth= 6 is 0.5603576751117735\n",
      "leafs= 50 , depth= 7 is 0.5948808473080318\n",
      "leafs= 50 , depth= 8 is 0.5837651122625216\n",
      "leafs= 50 , depth= 9 is 0.5724703737465816\n",
      "leafs= 50 , depth= 10 is 0.5745062836624776\n",
      "leafs= 60 , depth= 1 is 0.47959183673469385\n",
      "leafs= 60 , depth= 2 is 0.5126945126945127\n",
      "leafs= 60 , depth= 3 is 0.5301837270341208\n",
      "leafs= 60 , depth= 4 is 0.5228276877761414\n",
      "leafs= 60 , depth= 5 is 0.5839929639401935\n",
      "leafs= 60 , depth= 6 is 0.5595854922279793\n",
      "leafs= 60 , depth= 7 is 0.5946413137424373\n",
      "leafs= 60 , depth= 8 is 0.5832628909551987\n",
      "leafs= 60 , depth= 9 is 0.5978260869565217\n",
      "leafs= 60 , depth= 10 is 0.5920138888888888\n",
      "leafs= 70 , depth= 1 is 0.47959183673469385\n",
      "leafs= 70 , depth= 2 is 0.5126945126945127\n",
      "leafs= 70 , depth= 3 is 0.5301837270341208\n",
      "leafs= 70 , depth= 4 is 0.5228276877761414\n",
      "leafs= 70 , depth= 5 is 0.5839929639401935\n",
      "leafs= 70 , depth= 6 is 0.5595854922279793\n",
      "leafs= 70 , depth= 7 is 0.5982758620689655\n",
      "leafs= 70 , depth= 8 is 0.5868465430016864\n",
      "leafs= 70 , depth= 9 is 0.5941123996431757\n",
      "leafs= 70 , depth= 10 is 0.5899912203687445\n",
      "leafs= 80 , depth= 1 is 0.47959183673469385\n",
      "leafs= 80 , depth= 2 is 0.5126945126945127\n",
      "leafs= 80 , depth= 3 is 0.5301837270341208\n",
      "leafs= 80 , depth= 4 is 0.5228276877761414\n",
      "leafs= 80 , depth= 5 is 0.5839929639401935\n",
      "leafs= 80 , depth= 6 is 0.5595854922279793\n",
      "leafs= 80 , depth= 7 is 0.5940425531914894\n",
      "leafs= 80 , depth= 8 is 0.5828476269775187\n",
      "leafs= 80 , depth= 9 is 0.5852813852813853\n",
      "leafs= 80 , depth= 10 is 0.5814151747655584\n",
      "leafs= 90 , depth= 1 is 0.47959183673469385\n",
      "leafs= 90 , depth= 2 is 0.5126945126945127\n",
      "leafs= 90 , depth= 3 is 0.5301837270341208\n",
      "leafs= 90 , depth= 4 is 0.5228276877761414\n",
      "leafs= 90 , depth= 5 is 0.5769230769230769\n",
      "leafs= 90 , depth= 6 is 0.5537555228276878\n",
      "leafs= 90 , depth= 7 is 0.5871404399323181\n",
      "leafs= 90 , depth= 8 is 0.5754560530679934\n",
      "leafs= 90 , depth= 9 is 0.5766974015088013\n",
      "leafs= 90 , depth= 10 is 0.5730800990916598\n",
      "leafs= 100 , depth= 1 is 0.47959183673469385\n",
      "leafs= 100 , depth= 2 is 0.5126945126945127\n",
      "leafs= 100 , depth= 3 is 0.5301837270341208\n",
      "leafs= 100 , depth= 4 is 0.5228276877761414\n",
      "leafs= 100 , depth= 5 is 0.5764499121265377\n",
      "leafs= 100 , depth= 6 is 0.5569044006069803\n",
      "leafs= 100 , depth= 7 is 0.5862966175195143\n",
      "leafs= 100 , depth= 8 is 0.5849535080304311\n",
      "leafs= 100 , depth= 9 is 0.5849535080304311\n",
      "leafs= 100 , depth= 10 is 0.5802161263507897\n",
      "leafs= 110 , depth= 1 is 0.47959183673469385\n",
      "leafs= 110 , depth= 2 is 0.5126945126945127\n",
      "leafs= 110 , depth= 3 is 0.5301837270341208\n",
      "leafs= 110 , depth= 4 is 0.5228276877761414\n",
      "leafs= 110 , depth= 5 is 0.5764499121265377\n",
      "leafs= 110 , depth= 6 is 0.5569044006069803\n",
      "leafs= 110 , depth= 7 is 0.5862966175195143\n",
      "leafs= 110 , depth= 8 is 0.5849535080304311\n",
      "leafs= 110 , depth= 9 is 0.5849535080304311\n",
      "leafs= 110 , depth= 10 is 0.5849535080304311\n",
      "leafs= 120 , depth= 1 is 0.47959183673469385\n",
      "leafs= 120 , depth= 2 is 0.5126945126945127\n",
      "leafs= 120 , depth= 3 is 0.5301837270341208\n",
      "leafs= 120 , depth= 4 is 0.5228276877761414\n",
      "leafs= 120 , depth= 5 is 0.5764499121265377\n",
      "leafs= 120 , depth= 6 is 0.5569044006069803\n",
      "leafs= 120 , depth= 7 is 0.5799319727891157\n",
      "leafs= 120 , depth= 8 is 0.5787728026533997\n",
      "leafs= 120 , depth= 9 is 0.5787728026533997\n",
      "leafs= 120 , depth= 10 is 0.5787728026533997\n",
      "leafs= 130 , depth= 1 is 0.47959183673469385\n",
      "leafs= 130 , depth= 2 is 0.5126945126945127\n",
      "leafs= 130 , depth= 3 is 0.5301837270341208\n",
      "leafs= 130 , depth= 4 is 0.5228276877761414\n",
      "leafs= 130 , depth= 5 is 0.5462184873949579\n",
      "leafs= 130 , depth= 6 is 0.5453100158982512\n",
      "leafs= 130 , depth= 7 is 0.5654813529921943\n",
      "leafs= 130 , depth= 8 is 0.5596638655462185\n",
      "leafs= 130 , depth= 9 is 0.5596638655462185\n",
      "leafs= 130 , depth= 10 is 0.5596638655462185\n",
      "leafs= 140 , depth= 1 is 0.47959183673469385\n",
      "leafs= 140 , depth= 2 is 0.5126945126945127\n",
      "leafs= 140 , depth= 3 is 0.5301837270341208\n",
      "leafs= 140 , depth= 4 is 0.5228276877761414\n",
      "leafs= 140 , depth= 5 is 0.5510887772194305\n",
      "leafs= 140 , depth= 6 is 0.549800796812749\n",
      "leafs= 140 , depth= 7 is 0.5701906412478336\n",
      "leafs= 140 , depth= 8 is 0.5642317380352645\n",
      "leafs= 140 , depth= 9 is 0.5642317380352645\n",
      "leafs= 140 , depth= 10 is 0.5642317380352645\n",
      "leafs= 150 , depth= 1 is 0.47959183673469385\n",
      "leafs= 150 , depth= 2 is 0.5126945126945127\n",
      "leafs= 150 , depth= 3 is 0.5301837270341208\n",
      "leafs= 150 , depth= 4 is 0.5228276877761414\n",
      "leafs= 150 , depth= 5 is 0.5510887772194305\n",
      "leafs= 150 , depth= 6 is 0.549800796812749\n",
      "leafs= 150 , depth= 7 is 0.5696969696969697\n",
      "leafs= 150 , depth= 8 is 0.5637583892617449\n",
      "leafs= 150 , depth= 9 is 0.5637583892617449\n",
      "leafs= 150 , depth= 10 is 0.5637583892617449\n",
      "leafs= 160 , depth= 1 is 0.47959183673469385\n",
      "leafs= 160 , depth= 2 is 0.5126945126945127\n",
      "leafs= 160 , depth= 3 is 0.5301837270341208\n",
      "leafs= 160 , depth= 4 is 0.5228276877761414\n",
      "leafs= 160 , depth= 5 is 0.5578947368421052\n",
      "leafs= 160 , depth= 6 is 0.5633303808680248\n",
      "leafs= 160 , depth= 7 is 0.5514950166112956\n",
      "leafs= 160 , depth= 8 is 0.5514950166112956\n",
      "leafs= 160 , depth= 9 is 0.5514950166112956\n",
      "leafs= 160 , depth= 10 is 0.5514950166112956\n",
      "leafs= 170 , depth= 1 is 0.47959183673469385\n",
      "leafs= 170 , depth= 2 is 0.5126945126945127\n",
      "leafs= 170 , depth= 3 is 0.5301837270341208\n",
      "leafs= 170 , depth= 4 is 0.5228276877761414\n",
      "leafs= 170 , depth= 5 is 0.5506756756756757\n",
      "leafs= 170 , depth= 6 is 0.5558397271952259\n",
      "leafs= 170 , depth= 7 is 0.5460420032310178\n",
      "leafs= 170 , depth= 8 is 0.5460420032310178\n",
      "leafs= 170 , depth= 9 is 0.5460420032310178\n",
      "leafs= 170 , depth= 10 is 0.5460420032310178\n",
      "leafs= 180 , depth= 1 is 0.47959183673469385\n",
      "leafs= 180 , depth= 2 is 0.5126945126945127\n",
      "leafs= 180 , depth= 3 is 0.5301837270341208\n",
      "leafs= 180 , depth= 4 is 0.5228276877761414\n",
      "leafs= 180 , depth= 5 is 0.5506756756756757\n",
      "leafs= 180 , depth= 6 is 0.5558397271952259\n",
      "leafs= 180 , depth= 7 is 0.5537948290241869\n",
      "leafs= 180 , depth= 8 is 0.5537948290241869\n",
      "leafs= 180 , depth= 9 is 0.5537948290241869\n",
      "leafs= 180 , depth= 10 is 0.5537948290241869\n",
      "leafs= 190 , depth= 1 is 0.47959183673469385\n",
      "leafs= 190 , depth= 2 is 0.5126945126945127\n",
      "leafs= 190 , depth= 3 is 0.5301837270341208\n",
      "leafs= 190 , depth= 4 is 0.5228276877761414\n",
      "leafs= 190 , depth= 5 is 0.5506756756756757\n",
      "leafs= 190 , depth= 6 is 0.5558397271952259\n",
      "leafs= 190 , depth= 7 is 0.5537948290241869\n",
      "leafs= 190 , depth= 8 is 0.5537948290241869\n",
      "leafs= 190 , depth= 9 is 0.5537948290241869\n",
      "leafs= 190 , depth= 10 is 0.5537948290241869\n",
      "Mejor DecisionTreeClassifier - F1: 0.5982758620689655 | min_samples_leaf: 70 | max_depth: 7\n"
     ]
    }
   ],
   "source": [
    "# 9.1 Buscando mejores h√≠per par√°metros para DecisionTreeClassifier \n",
    "\n",
    "best_f1_tree = 0\n",
    "best_leafs = 0\n",
    "best_depth_tree = 0\n",
    "\n",
    "for leafs in range(10, 200, 10):\n",
    "    for depth in range(1, 11):\n",
    "        model_dtc = DecisionTreeClassifier(\n",
    "            min_samples_leaf=leafs,\n",
    "            max_depth=depth,\n",
    "            random_state=RANDOM_STATE\n",
    "        )\n",
    "        \n",
    "        model_dtc.fit(features_upsampled, target_upsampled)\n",
    "        predictions_valid = model_dtc.predict(features_valid_scaled)\n",
    "        f1 = f1_score(target_valid, predictions_valid)\n",
    "        # Imprime cada uno de los parametros provados.\n",
    "        # üëá Para ver solo el resultado final borrar esta linea.\n",
    "        print(\"leafs=\", leafs, \", depth=\", depth, \"is\", f1)\n",
    "\n",
    "        # Revisamos que cada valor de f1 se mayor al que tenemos guardado.\n",
    "        if f1 > best_f1_tree:\n",
    "            best_f1_tree = f1\n",
    "            best_leafs = leafs\n",
    "            best_depth_tree = depth\n",
    "\n",
    "# Imprimimos el mejor resultado encontrado con nuestros h√≠per parametros.\n",
    "print(\n",
    "    \"Mejor DecisionTreeClassifier - F1:\",\n",
    "    best_f1_tree,\n",
    "    \"| min_samples_leaf:\", best_leafs,\n",
    "    \"| max_depth:\", best_depth_tree\n",
    ")\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0aa08ed3",
   "metadata": {},
   "source": [
    "Mejor DecisionTreeClassifier - F1: 0.5982758620689655 | min_samples_leaf: 70 | max_depth: 7\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 66,
   "id": "15437f43",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "n_estimators 10 , depth= 10 f1 0.6109452736318408\n",
      "n_estimators 10 , depth= 20 f1 0.5727810650887574\n",
      "n_estimators 10 , depth= 30 f1 0.5565819861431871\n",
      "n_estimators 10 , depth= 40 f1 0.5565819861431871\n",
      "n_estimators 10 , depth= 50 f1 0.5565819861431871\n",
      "n_estimators 10 , depth= 60 f1 0.5565819861431871\n",
      "n_estimators 20 , depth= 10 f1 0.6007984031936128\n",
      "n_estimators 20 , depth= 20 f1 0.584971098265896\n",
      "n_estimators 20 , depth= 30 f1 0.5885057471264368\n",
      "n_estimators 20 , depth= 40 f1 0.5885057471264368\n",
      "n_estimators 20 , depth= 50 f1 0.5885057471264368\n",
      "n_estimators 20 , depth= 60 f1 0.5885057471264368\n",
      "n_estimators 30 , depth= 10 f1 0.6115035317860746\n",
      "n_estimators 30 , depth= 20 f1 0.5825688073394495\n",
      "n_estimators 30 , depth= 30 f1 0.5829493087557603\n",
      "n_estimators 30 , depth= 40 f1 0.5829493087557603\n",
      "n_estimators 30 , depth= 50 f1 0.5829493087557603\n",
      "n_estimators 30 , depth= 60 f1 0.5829493087557603\n",
      "n_estimators 40 , depth= 10 f1 0.6130653266331658\n",
      "n_estimators 40 , depth= 20 f1 0.5965317919075145\n",
      "n_estimators 40 , depth= 30 f1 0.5926773455377574\n",
      "n_estimators 40 , depth= 40 f1 0.5926773455377574\n",
      "n_estimators 40 , depth= 50 f1 0.5926773455377574\n",
      "n_estimators 40 , depth= 60 f1 0.5926773455377574\n",
      "n_estimators 50 , depth= 10 f1 0.6099290780141844\n",
      "n_estimators 50 , depth= 20 f1 0.5916473317865429\n",
      "n_estimators 50 , depth= 30 f1 0.5951557093425606\n",
      "n_estimators 50 , depth= 40 f1 0.5951557093425606\n",
      "n_estimators 50 , depth= 50 f1 0.5951557093425606\n",
      "n_estimators 50 , depth= 60 f1 0.5951557093425606\n",
      "n_estimators 60 , depth= 10 f1 0.6160081053698075\n",
      "n_estimators 60 , depth= 20 f1 0.5981735159817352\n",
      "n_estimators 60 , depth= 30 f1 0.593103448275862\n",
      "n_estimators 60 , depth= 40 f1 0.593103448275862\n",
      "n_estimators 60 , depth= 50 f1 0.593103448275862\n",
      "n_estimators 60 , depth= 60 f1 0.593103448275862\n",
      "n_estimators 70 , depth= 10 f1 0.6184738955823293\n",
      "n_estimators 70 , depth= 20 f1 0.5963302752293578\n",
      "n_estimators 70 , depth= 30 f1 0.5960874568469505\n",
      "n_estimators 70 , depth= 40 f1 0.5960874568469505\n",
      "n_estimators 70 , depth= 50 f1 0.5960874568469505\n",
      "n_estimators 70 , depth= 60 f1 0.5960874568469505\n",
      "n_estimators 80 , depth= 10 f1 0.6189516129032258\n",
      "n_estimators 80 , depth= 20 f1 0.5995423340961098\n",
      "n_estimators 80 , depth= 30 f1 0.5919075144508671\n",
      "n_estimators 80 , depth= 40 f1 0.5919075144508671\n",
      "n_estimators 80 , depth= 50 f1 0.5919075144508671\n",
      "n_estimators 80 , depth= 60 f1 0.5919075144508671\n",
      "n_estimators 90 , depth= 10 f1 0.6172344689378757\n",
      "n_estimators 90 , depth= 20 f1 0.5949656750572082\n",
      "n_estimators 90 , depth= 30 f1 0.5967741935483871\n",
      "n_estimators 90 , depth= 40 f1 0.5967741935483871\n",
      "n_estimators 90 , depth= 50 f1 0.5967741935483871\n",
      "n_estimators 90 , depth= 60 f1 0.5967741935483871\n",
      "n_estimators 100 , depth= 10 f1 0.6212424849699398\n",
      "n_estimators 100 , depth= 20 f1 0.5965714285714285\n",
      "n_estimators 100 , depth= 30 f1 0.5949074074074074\n",
      "n_estimators 100 , depth= 40 f1 0.5949074074074074\n",
      "n_estimators 100 , depth= 50 f1 0.5949074074074074\n",
      "n_estimators 100 , depth= 60 f1 0.5949074074074074\n",
      "Mejor RandomForestClassifier - F1: 0.6212424849699398 | n_estimators: 100 | max_depth: 10\n"
     ]
    }
   ],
   "source": [
    "# 9.2 Buscando mejores h√≠per par√°metros para RandomForestClassifier \n",
    "\n",
    "best_f1_rf = 0\n",
    "best_estimators_rf = 0\n",
    "best_depth_rf = 0\n",
    "\n",
    "for est in range(10, 101, 10):\n",
    "    for depth in range(10, 61, 10):\n",
    "        model = RandomForestClassifier(\n",
    "            random_state=RANDOM_STATE,\n",
    "            n_estimators=est,\n",
    "            max_depth=depth\n",
    "        )\n",
    "        \n",
    "        model.fit(features_upsampled, target_upsampled)\n",
    "        predictions_valid = model.predict(features_valid_scaled)\n",
    "        f1 = f1_score(target_valid, predictions_valid)\n",
    "        # Imprime cada uno de los parametros provados.\n",
    "        # üëá Para ver solo el resultado final borrar esta linea.\n",
    "        print(\"n_estimators\", est, \", depth=\", depth, \"f1\", f1)\n",
    "       \n",
    "        # Revisamos que cada valor de f1 se mayor al que tenemos guardado.\n",
    "        if f1 > best_f1_rf:\n",
    "            best_f1_rf = f1 \n",
    "            best_estimators_rf = est\n",
    "            best_depth_rf = depth\n",
    "\n",
    "\n",
    "# Imprimimos el mejor resultado encontrado con nuestros h√≠per parametros.\n",
    "print(\n",
    "    \"Mejor RandomForestClassifier - F1:\",\n",
    "    best_f1_rf,\n",
    "    \"| n_estimators:\", best_estimators_rf,\n",
    "    \"| max_depth:\", best_depth_rf\n",
    ")\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "81d13483",
   "metadata": {},
   "source": [
    "Mejor RandomForestClassifier - F1: 0.6212424849699398 | n_estimators: 100 | max_depth: 10\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "3476de08",
   "metadata": {},
   "source": [
    "#### 10. üìà M√©tricas \n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "4afb5fab",
   "metadata": {},
   "outputs": [],
   "source": [
    "# 10.1 Funci√≥n para obtenci√≥n de las m√©tricas de cada uno de nuestros modelos.\n",
    "\n",
    "def evaluar_modelo(model, X_valid, y_valid, nombre_modelo=\"modelo\"):\n",
    "    \n",
    "    # Predicciones de clase\n",
    "    y_pred = model.predict(X_valid)\n",
    "    \n",
    "    # Porvamos la probabilidades de la clase positiva (si el modelo las soporta)\n",
    "    if hasattr(model, \"predict_proba\"):\n",
    "        y_proba = model.predict_proba(X_valid)[:, 1]\n",
    "    else:\n",
    "        print(\"error\")\n",
    "\n",
    "    # Matriz de confuci√≥n.\n",
    "    tn, fp, fn, tp = confusion_matrix(y_valid, y_pred).ravel()\n",
    "    # Metricas relebantes a los modelos de Clasifici√≥n.\n",
    "    recall = recall_score(y_valid, y_pred)\n",
    "    precision = precision_score(y_valid, y_pred)\n",
    "    f1 = f1_score(y_valid, y_pred)\n",
    "    auc_roc = roc_auc_score(y_valid, y_proba)\n",
    "    curva_pr = average_precision_score(y_valid, y_proba)\n",
    "\n",
    "    # Pasamos los datos a un lista para ponerlo en una tabla\n",
    "    metrics = pd.DataFrame({\n",
    "        \"modelo\": [nombre_modelo],\n",
    "        \"Recall\": [recall],\n",
    "        \"F1\": [f1],\n",
    "        \"Curva PR\": [curva_pr],\n",
    "        \"AUC-ROC\": [auc_roc], \n",
    "        \"Precision\": [precision],\n",
    "        \"TP\": [tp],\n",
    "        \"FP\": [fp],\n",
    "        \"TN\": [tn],\n",
    "        \"FN\": [fn],\n",
    "\n",
    "    })\n",
    "    return metrics\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 68,
   "id": "baed9294",
   "metadata": {},
   "outputs": [],
   "source": [
    "resultados = []\n",
    "\n",
    "#=========================\n",
    "# Baseline Modelo (base) \n",
    "#=========================\n",
    "\n",
    "# Modelo (base) \n",
    "tree_base = DecisionTreeClassifier(\n",
    "    random_state=RANDOM_STATE, # Definido en el punto 1.2\n",
    "    max_depth=2 # Se utilizo 2 como punto de partida del modelo base.\n",
    ")\n",
    "\n",
    "# Se usara el train normal (escalado), sin upsampling.\n",
    "tree_base.fit(features_train_scaled, target_train)\n",
    "\n",
    "metrics_baseline = evaluar_modelo(\n",
    "    tree_base,              # modelo ya entrenado\n",
    "    features_valid_scaled,  # X_valid ‚Üí features de validaci√≥n escalado\n",
    "    target_valid,           # y_valid ‚Üí etiquetas reales\n",
    "    nombre_modelo=\"DecisionTreeClassifier (base)\" # Nombre de identifiacion del modelo \n",
    ")\n",
    "resultados.append(metrics_baseline)\n",
    "\n",
    "\n",
    "#=========================\n",
    "# DecisionTreeClassifier\n",
    "#=========================\n",
    " \n",
    "\n",
    "# Modelo + Mejores Hiperparametros \n",
    "model_rtree = DecisionTreeClassifier( \n",
    "    min_samples_leaf=best_leafs, # Obtenidos del punto 9.1\n",
    "    max_depth=best_depth_tree,  # Obtenidos del punto 9.1\n",
    "    random_state=RANDOM_STATE  # Definido en el punto 1.2\n",
    ")\n",
    "model_rtree.fit(features_upsampled, target_upsampled)\n",
    "\n",
    "metrics_rtree = evaluar_modelo(\n",
    "    model_rtree, # modelo ya entrenado\n",
    "    features_valid_scaled,# X_valid ‚Üí features de validaci√≥n escalado\n",
    "    target_valid, # y_valid ‚Üí etiquetas reales\n",
    "    nombre_modelo=\"DecisionTreeClassifier\" # Nombre de identifiaci√≥n del modelo\n",
    ")\n",
    "resultados.append(metrics_rtree)\n",
    "\n",
    "\n",
    "#=========================\n",
    "# RandomForestClassifier\n",
    "#=========================\n",
    "\n",
    "# Modelo + Mejores Hiperparametros \n",
    "\n",
    "model_rfc = RandomForestClassifier(\n",
    "    random_state=RANDOM_STATE,  # Definido en el punto 1.2\n",
    "    n_estimators=best_estimators_rf, # Obtenidos del punto 9.2\n",
    "    max_depth=best_depth_rf\n",
    ")\n",
    "model_rfc.fit(features_upsampled, target_upsampled)\n",
    "\n",
    "metrics_rfc = evaluar_modelo(\n",
    "    model_rfc, # modelo ya entrenado\n",
    "    features_valid_scaled,# X_valid ‚Üí features de validaci√≥n escalado\n",
    "    target_valid, # y_valid ‚Üí etiquetas reales\n",
    "    nombre_modelo=\"RandomForestClassifier\" # Nombre de identifiaci√≥n del modelo\n",
    ")\n",
    "resultados.append(metrics_rfc)\n",
    "\n",
    "\n",
    "#=========================\n",
    "# LogisticRegression \n",
    "#=========================\n",
    "\n",
    "# Modelo (normal)\n",
    "model_lgr = LogisticRegression(\n",
    "    random_state=RANDOM_STATE, # Definido en el punto 1.2\n",
    "    solver=\"liblinear\"\n",
    "\n",
    ")\n",
    "model_lgr.fit(features_upsampled, target_upsampled)\n",
    "\n",
    "metrics_lgr = evaluar_modelo(\n",
    "    model_lgr, # modelo ya entrenado\n",
    "    features_valid_scaled,# X_valid ‚Üí features de validaci√≥n escalado\n",
    "    target_valid, # y_valid ‚Üí etiquetas reales\n",
    "    nombre_modelo=\"LogisticRegression\" # Nombre de identifiaci√≥n del modelo\n",
    ")\n",
    "resultados.append(metrics_lgr)\n",
    "\n",
    "# Juntamos todos los resultados de los modelos en una tabla\n",
    "metrics_models = pd.concat(resultados, ignore_index=True)\n",
    "# Ordenamos por F1 de forma decendente dejando los mejores resultados de f1 arriba\n",
    "metrics_df_fmt = metrics_models.sort_values(\"F1\", ascending=False).reset_index(drop=True)\n",
    "\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "3bfd6c0e",
   "metadata": {},
   "source": [
    "### 11. üìù Resultados y an√°lisis\n",
    "\n",
    "**Observaciones generales:**\n",
    "\n",
    "- El objetivo del proyecto era alcanzar **F1 ‚â• 0.59**.\n",
    "- El modelo con **mayor F1** es: `RandomForestClassifier` con **F1 ‚âà 0.62**.\n",
    "\n",
    "---\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 69,
   "id": "5b7e511a",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>modelo</th>\n",
       "      <th>Recall</th>\n",
       "      <th>F1</th>\n",
       "      <th>Curva PR</th>\n",
       "      <th>AUC-ROC</th>\n",
       "      <th>Precision</th>\n",
       "      <th>TP</th>\n",
       "      <th>FP</th>\n",
       "      <th>TN</th>\n",
       "      <th>FN</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>RandomForestClassifier</td>\n",
       "      <td>0.648536</td>\n",
       "      <td>0.621242</td>\n",
       "      <td>0.694817</td>\n",
       "      <td>0.871827</td>\n",
       "      <td>0.596154</td>\n",
       "      <td>310</td>\n",
       "      <td>210</td>\n",
       "      <td>1812</td>\n",
       "      <td>168</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>DecisionTreeClassifier</td>\n",
       "      <td>0.725941</td>\n",
       "      <td>0.598276</td>\n",
       "      <td>0.672317</td>\n",
       "      <td>0.861913</td>\n",
       "      <td>0.508798</td>\n",
       "      <td>347</td>\n",
       "      <td>335</td>\n",
       "      <td>1687</td>\n",
       "      <td>131</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>DecisionTreeClassifier (base)</td>\n",
       "      <td>0.458159</td>\n",
       "      <td>0.517730</td>\n",
       "      <td>0.427579</td>\n",
       "      <td>0.746469</td>\n",
       "      <td>0.595109</td>\n",
       "      <td>219</td>\n",
       "      <td>149</td>\n",
       "      <td>1873</td>\n",
       "      <td>259</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>LogisticRegression</td>\n",
       "      <td>0.600418</td>\n",
       "      <td>0.493976</td>\n",
       "      <td>0.446312</td>\n",
       "      <td>0.778951</td>\n",
       "      <td>0.419591</td>\n",
       "      <td>287</td>\n",
       "      <td>397</td>\n",
       "      <td>1625</td>\n",
       "      <td>191</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "                          modelo    Recall        F1  Curva PR   AUC-ROC  \\\n",
       "0         RandomForestClassifier  0.648536  0.621242  0.694817  0.871827   \n",
       "1         DecisionTreeClassifier  0.725941  0.598276  0.672317  0.861913   \n",
       "2  DecisionTreeClassifier (base)  0.458159  0.517730  0.427579  0.746469   \n",
       "3             LogisticRegression  0.600418  0.493976  0.446312  0.778951   \n",
       "\n",
       "   Precision   TP   FP    TN   FN  \n",
       "0   0.596154  310  210  1812  168  \n",
       "1   0.508798  347  335  1687  131  \n",
       "2   0.595109  219  149  1873  259  \n",
       "3   0.419591  287  397  1625  191  "
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "display(metrics_df_fmt)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "0195c260",
   "metadata": {},
   "source": [
    "#### 11.2 üîç An√°lisis del modelo seleccionado: RandomForestClassifier\n",
    "\n",
    "**M√©tricas clave del RandomForestClassifier:**\n",
    "\n",
    "- **Recall:** 0.6485  \n",
    "  - Interpretaci√≥n: de todos los clientes que realmente abandonan el banco, el modelo detecta aproximadamente el **65%**.  \n",
    "  - TP (Verdaderos Positivos) = 310, FN (Falsos negativos)= 168.  \n",
    "  - Es importante mantener un recall alto, ya que podemos identificar personas que se van del banco\n",
    "\n",
    "- **Precision:** 0.5962  \n",
    "  - Interpretaci√≥n: de todos los clientes que el modelo marca como ‚Äúse va‚Äù, alrededor del **60%** realmente se va.  \n",
    "  - FP = 210.  \n",
    "  - Al tener una precisi√≥n alta podemos hacer una campa√±a de retenci√≥n mucho m√°s barta, ya que realmente estar√≠amos llegando a las personas que realmente se van. De otra manera estamos desperdiciando presupuesto un 40 % de presupuesto en personas que pensamos que se van cuando realmente no se van del banco.\n",
    "\n",
    "- **F1-score:** 0.6212  \n",
    "  - Es la m√©trica que combina Precision y Recall, y es la que usamos como criterio principal.  \n",
    "  - El modelo cumple el objetivo del proyecto (**F1 ‚â• 0.59**).  \n",
    "  - El modelo `RandomForestClassifier` considero que es el mejor modelo para este problema, ya que alcanzo mayor F1 comparaci√≥n del resto de modelos de clasificaci√≥n esto nos da un buen balance entre Precision y Recall.\n",
    "\n",
    "- **AUC-ROC:** 0.8718  \n",
    "  - Indica una muy buena capacidad de separaci√≥n entre clientes que se quedan y clientes que se van.  \n",
    "  - Tener un AUC-ROC cerca a 1 ayuda a organizar a los clientes con riesgo de que dejen el banco.\n",
    "\n",
    "- **Curva PR (Average Precision):** 0.6948  \n",
    "  - Refuerza que el modelo mantiene una buena relaci√≥n entre Precision y Recall en diferentes umbrales.  \n",
    "  - En promedio, a lo largo de distintos umbrales, el modelo mantiene una precisi√≥n bastante buena mientras aumenta el recall"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c241d922",
   "metadata": {},
   "source": [
    "#### 11.3 ‚öñÔ∏è Comparaci√≥n con otros modelos\n",
    "\n",
    "- **DecisionTreeClassifier (Mejorado):**\n",
    "  - Tiene un **Recall m√°s alto (‚âà 0.73)** que el RandomForest, pero una **Precision menor (‚âà 0.51)**.\n",
    "  - Esto significa que detecta m√°s clientes que se van, pero tambi√©n genera muchos m√°s falsos positivos.\n",
    "  - **F1 = 0.5983**, menor que el RandomForest.\n",
    "  - Un mejor equilibrio nos ayuda a no incluir tantos clientes que realmente no se van (Falsos Positivos), maximisando nuestros esfuerzos en retencion de clientes.\n",
    "\n",
    "- **DecisionTree (base):**\n",
    "  - Serve como **modelo base** con F1 ‚âà 0.52 y AUC-ROC ‚âà 0.75.\n",
    "  - Tiene menos recall (‚âà 0.46) y deja escapar muchos clientes que abandonan (FN = 259).\n",
    "  - Este modelo se toma como base inicial para analizar el comportamiento de los datos con un enfoque sencillo y sin optimizaci√≥n de hiperpar√°metros. Esto nos permite comparar de forma consistente distintos modelos sobre los mismos datos y elegir aquellos que ofrezcan el mejor desempe√±o.\n",
    "\n",
    "- **LogisticRegression:**\n",
    "  - Muestra un **AUC-ROC decente (‚âà 0.78)**, pero F1 m√°s bajo (‚âà 0.49).\n",
    "  - Su Precision es la m√°s baja (‚âà 0.42), generando muchos falsos positivos (FP = 397).\n",
    "  - Este modelo no lo usamos ya que aunque tiene un AUC-ROC alto al comparar el F1 resulta mucho mas bajo que los otros modelos incluso mas bajo que el modelo base.\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "cffd6354",
   "metadata": {},
   "source": [
    "**Conclusi√≥n:**  \n",
    "El **RandomForestClassifier** es el que mejor equilibra Precision, Recall y F1.  \n",
    "Adem√°s tiene un AUC-ROC alto, as√≠ que es el modelo m√°s s√≥lido para este problema.\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 70,
   "id": "cbc9c523",
   "metadata": {},
   "outputs": [
    {
     "data": {
      "text/html": [
       "<div>\n",
       "<style scoped>\n",
       "    .dataframe tbody tr th:only-of-type {\n",
       "        vertical-align: middle;\n",
       "    }\n",
       "\n",
       "    .dataframe tbody tr th {\n",
       "        vertical-align: top;\n",
       "    }\n",
       "\n",
       "    .dataframe thead th {\n",
       "        text-align: right;\n",
       "    }\n",
       "</style>\n",
       "<table border=\"1\" class=\"dataframe\">\n",
       "  <thead>\n",
       "    <tr style=\"text-align: right;\">\n",
       "      <th></th>\n",
       "      <th>feature</th>\n",
       "      <th>importance</th>\n",
       "    </tr>\n",
       "  </thead>\n",
       "  <tbody>\n",
       "    <tr>\n",
       "      <th>0</th>\n",
       "      <td>Age</td>\n",
       "      <td>0.331454</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>1</th>\n",
       "      <td>NumOfProducts</td>\n",
       "      <td>0.220817</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>2</th>\n",
       "      <td>Balance</td>\n",
       "      <td>0.107224</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>3</th>\n",
       "      <td>EstimatedSalary</td>\n",
       "      <td>0.074737</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>4</th>\n",
       "      <td>CreditScore</td>\n",
       "      <td>0.070907</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>5</th>\n",
       "      <td>IsActiveMember</td>\n",
       "      <td>0.056697</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>6</th>\n",
       "      <td>Geography_Germany</td>\n",
       "      <td>0.048976</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>7</th>\n",
       "      <td>Tenure</td>\n",
       "      <td>0.039229</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>8</th>\n",
       "      <td>Gender_Male</td>\n",
       "      <td>0.026373</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>9</th>\n",
       "      <td>Geography_Spain</td>\n",
       "      <td>0.008883</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>10</th>\n",
       "      <td>HasCrCard</td>\n",
       "      <td>0.008751</td>\n",
       "    </tr>\n",
       "    <tr>\n",
       "      <th>11</th>\n",
       "      <td>TenureWasMissing</td>\n",
       "      <td>0.005951</td>\n",
       "    </tr>\n",
       "  </tbody>\n",
       "</table>\n",
       "</div>"
      ],
      "text/plain": [
       "              feature  importance\n",
       "0                 Age    0.331454\n",
       "1       NumOfProducts    0.220817\n",
       "2             Balance    0.107224\n",
       "3     EstimatedSalary    0.074737\n",
       "4         CreditScore    0.070907\n",
       "5      IsActiveMember    0.056697\n",
       "6   Geography_Germany    0.048976\n",
       "7              Tenure    0.039229\n",
       "8         Gender_Male    0.026373\n",
       "9     Geography_Spain    0.008883\n",
       "10          HasCrCard    0.008751\n",
       "11   TenureWasMissing    0.005951"
      ]
     },
     "metadata": {},
     "output_type": "display_data"
    }
   ],
   "source": [
    "importancia = pd.DataFrame({\n",
    "    \"feature\": features.columns,\n",
    "    \"importance\": model_rfc.feature_importances_\n",
    "}).sort_values(\"importance\", ascending=False).reset_index(drop=True)\n",
    "\n",
    "display(importancia)"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "08241b09",
   "metadata": {},
   "source": [
    "**Interpretaci√≥n:**\n",
    "\n",
    "- Las caracter√≠sticas **m√°s influyentes** en la predicci√≥n de churn son:\n",
    "  - **Age**\n",
    "  - **NumOfProducts**\n",
    "  - **Balance**\n",
    "  - **EstimatedSalary**\n",
    "  - **CreditScore**\n",
    "- Esto sugiere que el riesgo de churn est√° muy relacionado con:\n",
    "  - La **edad** del cliente,\n",
    "  - La **cantidad de productos contratados**,\n",
    "  - Y su **perfil financiero** (saldo, salario estimado, score de cr√©dito).\n",
    "- La variable `TenureWasMissing` tiene una importancia muy baja, lo que indica que:\n",
    "  - Marcar los nulos fue √∫til para probar la hip√≥tesis, pero no result√≥ ser un factor clave en la predicci√≥n\n",
    "\n",
    "---\n",
    "\n",
    "\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "bd4ac08e",
   "metadata": {},
   "source": [
    "#### 11.5 üß† Resumen del an√°lisis\n",
    "\n",
    "- Modelo final: **RandomForestClassifier**  \n",
    "- F1 ‚âà 0.62 (cumple la meta)  \n",
    "- AUC-ROC ‚âà 0.87 (muy buena separaci√≥n)  \n",
    "- Buen equilibrio entre detectar clientes en riesgo y no generar demasiados falsos positivos\n",
    "\n",
    "**Variables m√°s importantes:**\n",
    "- Age  \n",
    "- NumOfProducts  \n",
    "- Balance  \n",
    "- EstimatedSalary  \n",
    "- CreditScore  \n",
    "\n",
    "Estas variables reflejan el perfil financiero del cliente y qu√© tanto usa los productos del banco.\n",
    "\n",
    "`TenureWasMissing` casi no aporta, as√≠ que no es una variable clave.\n",
    "\n",
    "**En resumen:**  \n",
    "El modelo ayuda a identificar clientes con alta probabilidad de irse para enfocar campa√±as de retenci√≥n en ellos.  \n",
    "Como siguiente paso, generar√≠a una lista de clientes ordenados por riesgo y comenzar√≠a acciones espec√≠ficas para retenerlos.\n"
   ]
  },
  {
   "cell_type": "markdown",
   "id": "c8062c46",
   "metadata": {},
   "source": []
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "ml (3.14.0)",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.14.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
